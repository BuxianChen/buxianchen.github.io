---
layout: post
title: "(WIP) Auto-GPTQ æµ…æ"
date: 2023-06-26 10:10:04 +0800
labels: [huggingface, repo]
---

## åŠ¨æœºã€å‚è€ƒèµ„æ–™ã€æ¶‰åŠå†…å®¹

åŠ¨æœº

- Auto-GPTQ æºç æµ…æ
  - æ€ä¹ˆå†™ä¸€ä¸ª python åŒ… (setup.py)
  - Github Action åšåˆ†å‘
  - torch cpp extension çš„ä½¿ç”¨
  - OpenAI triton çš„ä½¿ç”¨
  - æ€ä¹ˆåŸºäº ğŸ¤— åšäºŒæ¬¡å¼€å‘çš„ä¾‹å­

å‚è€ƒèµ„æ–™

- åŸå§‹ä»£ç ä»“åº“: [https://github.com/PanQiWei/AutoGPTQ.git](https://github.com/PanQiWei/AutoGPTQ.git)

æ¶‰åŠå†…å®¹

åŒåŠ¨æœº

ä¸æ¶‰åŠå†…å®¹

torch cpp extension åŠ OpenAI triton çš„æ·±åº¦ä½¿ç”¨


## é¡¹ç›®ç›®å½•ç»“æ„

```
README.md
setup.py
docs/
examples/
.github/                            # ä¸ GitHub ä¸å‘å¸ƒç›¸å…³çš„
auto_gptq/                          # å®‰è£…çš„ python åŒ…
    __init__.py
    eval_tasks/                     # è¯„ä¼°é‡åŒ–ç»“æœ
    modeling/
        __init__.py
        _base.py                    # æ ¸å¿ƒç±»: BaseQuantizeConfig, BaseGPTQForCausalLM
        auto.py                     # æ ¸å¿ƒç±»: AutoGPTQForCausalLM
        llama.py                    # bloom.py, gptq2.py, ..., ç»§æ‰¿è‡ª BaseGPTQForCausalLM, ä½†åªä¿®æ”¹å‡ ä¸ªç±»å±æ€§
        ...
    nn_modules/                     # å¾…ç ”ç©¶
        __init__.py
        _fused_base.py
        fused_gptj_attn.py
        fused_llama_attn.py
        fused_llama_mlp.py
        qlinear/
            __init__.py
            qlinear_cuda.py
            qlinear_cuda_old.py
            qlinear_triton.py
        triton_utils/
            __init__.py
            custom_autotune.py
            kernels.py
            mixin.py
    quantization/
        __init__.py
        gptq.py
        quantizer.py
    utils/
        ...
        peft_utils.py               # ğŸ¤— Peft çš„é›†æˆ
autogptq_cuda/                      # Pytorch CUDAExtension 
    autogptq_cuda_256.cpp
    autogptq_cuda_64.cpp
    autogptq_cuda_kernel_256.cu
    autogptq_cuda_kernel_64.cu
```

## setup.py

æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„æè¿°, ä½¿ç”¨ `pip install` çš„æ–¹å¼è¿›è¡Œå®‰è£…æœ‰å¦‚ä¸‹å‡ ç§é€‰é¡¹

```bash
# ç¡®è®¤ä¹‹å‰çš„å®‰è£…è¢«åˆ é™¤
pip uninstall autogptq_cuda -y

# å®‰è£…æ—¶ä½¿ç”¨ pytorch ç¼–è¯‘ extension
pip install autogptq  # ç­‰ä»·ä¸ BUILD_CUDA_EXT=1 pip install auto-gptq

# å®‰è£…æ—¶ä¸ç¼–è¯‘ extension
BUILD_CUDA_EXT=0 pip install auto-gptq

# é¢å¤–å®‰è£… triton
pip install auto-gptq[triton]
```

ä¸Šé¢çš„æ³¨é‡Šå®é™…ä¸Šæœ‰äº›â€œå«ç³Šâ€, å› æ­¤è¿™é‡Œç›´æ¥å¯¹ `setup.py` è¿›è¡Œåˆ†æ, ä»¥å¾—åˆ°å‡†ç¡®ç†è§£

```python
# å…³é”®éƒ¨åˆ†ä»£ç 
common_setup_kwargs = {
    "python_requires": f">=3.8.0",                            # å¼ºåˆ¶æ£€æŸ¥, å¦åˆ™å®‰è£…æŠ¥é”™
    # ä»¥ä¸‹åªæœ‰åœ¨ BUILD_CUDA_EXT="1", ä¸” torch å­˜åœ¨æ—¶æ‰æœ‰ã€å¾…ç¡®è®¤ä»€ä¹ˆå«torchå­˜åœ¨ã€‘
    "ext_modules": [
        cpp_extension.CUDAExtension(
            "autogptq_cuda_64",
            [
                "autogptq_cuda/autogptq_cuda_64.cpp",
                "autogptq_cuda/autogptq_cuda_kernel_64.cu"
            ]
        ),
        cpp_extension.CUDAExtension(
            "autogptq_cuda_256",
            [
                "autogptq_cuda/autogptq_cuda_256.cpp",
                "autogptq_cuda/autogptq_cuda_kernel_256.cu"
            ]
        )
    ],
    "cmdclass": {'build_ext': cpp_extension.BuildExtension}
}

include_dirs = [
    "autogptq_cuda"
    ""  # ã€éœ€è¦ä½¿ç”¨Pytorch extensionæ—¶è¿˜ä¼šå¢åŠ ã€‘
]

setup(
    packages=find_packages(),       # ["auto_gptq"]
    install_requires=requirements,  # è‡ªåŠ¨å®‰è£…: ["accelerate>=0.19.0", "torch>=1.13.0", "transformers>=4.29.0", "peft", ...]
    extras_require=extras_require,  # è‡ªåŠ¨å®‰è£…, ä½¿ç”¨ pip install auto-gptq[triton] æ‰ä¼šè§¦å‘ {"triton": ["triton>=2.0.0"]}
    include_dirs=include_dirs,      # ä¹Ÿæ”¾å…¥ site-packages ç›®å½•å†…
    **common_setup_kwargs
)
```

å…³äº `extras_require` ä¸ `pip install xx[yy,zz]`: ã€å¾…ç¡®è®¤å¹¶ç§»å…¥Notesä¸­ã€‘

- å…ˆåˆ¤æ–­ `"yy"` æ˜¯å¦æ˜¯ `extras_require` çš„é”®, å¦‚æœåŒ¹é…ä¸Š, å°±å®‰è£… `extras_require["yy"]` çš„åŒ…, åŒ¹é…ä¸ä¸Šå°±æŠ¥ä¸€ä¸ªè­¦å‘Š, ç„¶åè¿›è¡Œä¸‹ä¸€æ­¥
- ç„¶ååˆ¤æ–­ `yy` æ˜¯å¦ä¸ºä¸€ä¸ªåŒ…å(PyPI), å¦‚æœåŒ¹é…ä¸Š, å°±å®‰è£… `yy` åŒ…
- éƒ½åŒ¹é…ä¸ä¸Šå°±ä¸è¿›è¡Œå®‰è£… `yy`

æºç å®‰è£…

```bash
pip install .[triton]
```


å¦‚æœ Pytorch CUDA extension è¢«æ­£ç¡®å®‰è£…, å®‰è£…ä½ç½®ä¸º
```
/path/to/site-packages/autogptq_cuda_256.cpython-38-x86_64-linux-gnu.so
/path/to/site-packages/autogptq_cuda_64.cpython-38-x86_64-linux-gnu.so
```


æç¤º: å¦‚æœå¸Œæœ›çœ‹å‡ºä¸€äº›å®‰è£…è¿‡ç¨‹å…·ä½“å¹²äº†ä»€ä¹ˆ, å¯ä»¥å°è¯•ä½¿ç”¨ `pip install -v .`

é€šå¸¸ä¸æ¨èä½¿ç”¨: `python setup.py install`, å‚è€ƒ [stackoverflow](https://stackoverflow.com/questions/15724093/difference-between-python-setup-py-install-and-pip-install)

```python
pip install -e -v .
# pip install . ç›¸å½“äºåœ¨ python setup.py install ä¹‹å¤–è¿˜åšäº†è‡ªåŠ¨å®‰è£…ä¾èµ–åŒ…ç­‰å·¥ä½œ
# -e å‚æ•°æ–¹ä¾¿è°ƒè¯•, é¡¹ç›®ç›®å½•ä¸‹çš„ä¿®æ”¹ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ
# -v ç”¨äºæ˜¾ç¤ºå®‰è£…è¿‡ç¨‹, ä¾‹å¦‚è®© setup.py æ–‡ä»¶ä¸­çš„ print èƒ½æ­£å¸¸ç”Ÿæ•ˆ
```

æ—¥å¿—å¦‚ä¸‹
```
# ä»¥ # å·å¼€å¤´çš„æ˜¯æ³¨é‡Š

Processing /abspath/to/AutoGPTQ
  Running command python setup.py egg_info
  ...  # è¿™ä¸€éƒ¨åˆ†ä¼šæ‰“å° setup.py ä¸­çš„ print è¯­å¥è¾“å‡º
  running egg_info
  # åˆ›å»ºä¸€äº›ä¸´æ—¶ç›®å½•, å¹¶å†™æ–‡ä»¶
  writing /tmp/pip-pip-egg-info-eoiqxgek/auto_gptq.egg-info/PKG-INFO
  ...
  Prepareing metadata (setup.py) ... done
# å®‰è£…ä¾èµ–åŒ…
Collecting accelerate>=0.19.0
...
Building wheels for collected packages: auto-gptq
  Running command python setup.py bdist_wheel
  running bdist_wheel
  running build
  running build_py
  # æ‹·è´æ–‡ä»¶åˆ° build ç›®å½•
  create build/lib/auto_gptq
  copy auto_gptq/__init__.py -> build/lib/auto_gptq
  ...
  # å¦‚æœBUILD_CUDA_EXT=1(é»˜è®¤å€¼), ä¸”å®‰è£…auto-gptqä¹‹å‰å°±å·²ç»å®‰è£…äº†torchæ—¶ä¼šè§¦å‘
  running build_ext
  ...
  running install
  running install_lib
  # å†æ‹·è´ä¸€æ¬¡
  copy build/lib/auto_gptq/__init__py -> build/bdist.linux-x86_64/wheel/auto_gptq
  ...
  running install_egg_info
  running egg_info
  # ç–‘ä¼¼æ˜¯å†™åˆ° site-packages/auto_gptq.egg-info ä¸­
  writing auto_gptq.egg-info/PKG-INFO
  ...
  running install_scripts
  creating build/bdist.linux-x86_64/wheel/auto_gptq-0.3.0.dev0.dist-info/WHEEL
  creating '/tmp/pip-wheel-nlkqzuc6/auto_gptq-0.3.0.dev0-py3-none-any.whl' and adding 'build/bdist.linux-x86_64/wheel' to it
  adding 'auto_gptq/__init__.py'
  ...
  removing build/bdist.linux-x86_64/wheel
  Building wheel for auto-gptq (setup.py) ... done
  Created wheel for auto-gptq: filename=auto_gptq-0.3.0.dev0-py3-none-any.whl size=63666 sha256=12345163663
  Store in directory: /tmp/pip-ephem-wheel-cache-5yjlc9ij/wheels/36/9a/b2/12355772277
Successfully build auto-gptq
Installing collected packages: accelerate, auto-gptq
  # ä¸Šä¸€è¡Œè¿è¡Œä¹‹åå¯èƒ½ä¼šå¡ä½ä¸€æ®µæ—¶é—´, åº”è¯¥æ˜¯æŠŠå‰é¢çš„ä¸´æ—¶æ–‡ä»¶å¤¹è¿›è¡Œæ‹·è´
  # /tmp/pip-wheel-nlkqzuc6, /tmp/pip-ephem-wheel-cache-5yjlc9ij
  changing model of /path/to/python/bin/accelerate to 755
  changing model of /path/to/python/bin/accelerate-config to 755
  changing model of /path/to/python/bin/accelerate-launch to 755
Successfully installed accelerate-0.19.0 auto-gptq-0.3.0-dev0
```

å¤‡æ³¨: `/tmp` ç›®å½•çš„ä½¿ç”¨å®é™…ä¸Šè¿˜æœ‰æ›´å¤š, ä½†æœ€ç»ˆä¼šè¢«æ¸…ç†æ‰
```
pip-build-tracker-xxxx
pip-ephem-wheel-cahce-xxxx
pip-install-xxxx
pip-pip-egg-info-xxxx
pip-unpack-xxxx
pip-wheel-xxxx
```



### CUDA extension å®‰è£…å¯èƒ½æŠ¥é”™çš„é—®é¢˜

```
error identifier "__hfma2" is undefined
```

nvcc æ€ä¹ˆç¡®å®šç±»ä¼¼è¿™ç§å‚æ•° `-gencode=arch=compute_70,code=sm_70`, å‚è€ƒ:

- [åšå®¢](https://arnon.dk/matching-sm-architectures-arch-and-gencode-for-various-nvidia-cards/)
- [issue](https://github.com/PanQiWei/AutoGPTQ/issues/67#issuecomment-1577775096)
- [é—®ç­”](https://stackoverflow.com/questions/68496906/pytorch-installation-for-different-cuda-architectures)

```
TORCH_CUDA_ARCH_LIST=7.0
/usr/local/cuda-11.7/bin/nvcc --list-gpu-arch
```


