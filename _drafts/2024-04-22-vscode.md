---
layout: post
title: "(P1) VSCode 使用记录"
date: 2024-04-22 10:05:04 +0800
labels: [VSCode]
---

## CUDA C/C++

所需插件

- [Nsight Visual Studio Code Edition](https://docs.nvidia.com/nsight-visual-studio-code-edition/)
- [C/C++](https://code.visualstudio.com/docs/languages/cpp)

基本使用参考:

- 官方文档: [Nsight Visual Studio Code Edition](https://docs.nvidia.com/nsight-visual-studio-code-edition/)
- Youtube 视频: [https://www.youtube.com/watch?v=gN3XeFwZ4ng](https://www.youtube.com/watch?v=gN3XeFwZ4ng)

简要提几个点 (只做记录, 优先参考上面的文档及视频):

- 命令行编译: 官方文档里的例子是用 [CUDA Samples: matrixMul.cu](https://github.com/NVIDIA/cuda-samples/blob/master/Samples/0_Introduction/matrixMul/matrixMul.cu) 进行举例的, 然而 `matrixMul.cu` 并不是一个 standalone 的单一源码文件, 代码里还包含了诸如 `#include <helper_cuda.h>` 的编译预处理指令, 所以如果用命令行编译运行/调试, 应该用以下语句
    ```bash
    cd /path/to/samples/0_Simple/matrixMul
    nvcc matrixMul.cu -I../../common/inc -o matrixMul
    # nvcc matrixMul.cu -I../../common/inc -o matrixMul -g -G  # 包含可调试的编译
    ./matrixMul  # 运行可执行文件
    ```
    当然更正规的用法是使用同目录的 `Makefile`:
    ```bash
    make          # 本质上是复杂版的手工编译
    # make dbg=1  # 包含可调试的编译, 本质上是复杂版的可调试手工编译
    ./matrixMul
    ```
- 命令行调试:
    ```bash
    cuda-gdb  # 以下是 cuda-gdb 命令行, (cuda-gdb) 是提示符, 无需输入
    (cuda-gdb) break matrixMul.cu:58
    (cuda-gdb) break matrixMul.cu:72
    (cuda-gdb) run   # 开始运行
    # 使用 c 表示 continue 继续, s 表示 step 进入函数, ...
    ```
- 使用 IDE debug 代码必须先编译好可调试的可执行文件, 也就是对应上面的命令行编译. 对应于 `tasks.json` (配置文件使用: `Ctrl+Shift+P` + `Tasks: Configure Default Build Task`, 执行编译使用: `Ctrl+Shift+P` + `Tasks: Run Build Task`)
- 使用 IDE 运行 debug 需要配置 `launch.json` 文件, 也就是对应上面的命令行调试.
- 进行性能分析可视化一般使用 Nsight Systems 和 Nsight Compute 工具 (Nsight Visual Profiler 工具只适用于较早版本的 CUDA) ([参考](https://gpuhackshef.readthedocs.io/en/latest/tools/nvidia-profiling-tools.html)), 采用这个流程:
    ```bash
    nvcc -lineinfo -O2 -o matrixMul -I../../common/inc  matrixMul.cu
    # nvprof -o matrixMul.nvprof ./matrixMul     # Nsight Profiler, 现已弃用
    nsys profile -o matrixMul.qdrep ./matrixMul  # Nsight Systems
    # 然后使用 Nsight Systems 打开 matrixMul.qdrep 文件, 可以看到可视化结果
    ```
    [Nsight Systems](https://developer.nvidia.com/nsight-systems) 可以在本机单独安装 (与服务器 Nsight System 版本相近即可, 本机无需有 GPU), 从服务器上下载 `.qdrep`, 然后用 Nsight Systems 打开.

完整操作供参考:

1. 远程连接服务器, `git clone https://github.com/NVIDIA/cuda-samples`, 在 `/path/to/cuda-samples/0_Simple/matrixMul` 作为工作目录打开

2. 编辑 `.vscode/launch.json` 文件

```json
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "CUDA C++: Launch",
            "type": "cuda-gdb",
            "request": "launch",
            "program": "${workspaceFolder}/matrixMul"
        }
    ]
}
```

3. 编辑 `./vscode/tasks.json` 文件

```
{
    "tasks": [
        {
            "type": "shell",
            "label": "Nsight: autostart (localhost)",
            "command": "make dbg=1",
            "problemMatcher": ["$nvcc"],
            "group": {
                "kind": "build",
                "isDefault": true
            }
        }
    ]
}
```

4. 使用 `CTRL+Shift+P`, 选择 `Tasks: Run Build Task`, 得到可调试的可执行文件 `matrixMul`

5. 在 `matrixMul.cu` 文件内用鼠标打上断点

6. 选择 VSCode 左侧边栏 Debug 图标后点击启动调试按钮